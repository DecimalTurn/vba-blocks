name: Windows Integration Test

on:
  push:
    branches:
      - main
      - dev
      - dev-*
    paths-ignore:
      - '**/*.md'
  pull_request:
  workflow_dispatch:

jobs:
  # Quick smoke test without Office - runs on every push
  smoke-test:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies and build
        run: |
          npm install
          npm run build

      - name: Install globally from local build
        shell: pwsh
        run: |
          npm install -g .

      - name: Verify installation
        shell: pwsh
        run: |
          vba --version
          vba --help

      - name: Create a new VBA package
        shell: pwsh
        run: |
          vba new my-package --package

      - name: Show project structure
        shell: pwsh
        run: |
          Get-ChildItem -Recurse my-package | Select-Object FullName

      - name: Test vba init (package mode)
        shell: pwsh
        run: |
          mkdir init-test
          cd init-test
          vba init --package --name my-library --no-git

          if (-not (Test-Path "vba_package.toml")) {
            Write-Error "vba init FAILED: vba_package.toml not found"
            exit 1
          }

          $toml = Get-Content "vba_package.toml" -Raw
          if ($toml -match 'name = "my-library"') {
            Write-Host "vba init PASSED: project name set correctly"
          } else {
            Write-Error "vba init FAILED: unexpected toml content"
            Write-Host $toml
            exit 1
          }

          if (Test-Path "src") {
            Write-Host "vba init PASSED: src/ directory created"
          } else {
            Write-Error "vba init FAILED: src/ directory not found"
            exit 1
          }

      - name: Upload project artifact
        uses: actions/upload-artifact@v4
        with:
          name: vba-package
          path: my-package/

  # Full integration test with Office installed
  excel-integration:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup VBA runtime
        uses: DecimalTurn/setup-vba@main
        with:
          office-apps: Excel

      - name: Configure Excel trust settings
        shell: pwsh
        run: |
          # Disable Protected View for all sources (prevents blocking COM automation)
          $pvPath = "HKCU:\Software\Microsoft\Office\16.0\Excel\Security\ProtectedView"
          if (-not (Test-Path $pvPath)) { New-Item -Path $pvPath -Force | Out-Null }
          Set-ItemProperty -Path $pvPath -Name "DisableInternetFilesInPV" -Value 1 -Type DWord
          Set-ItemProperty -Path $pvPath -Name "DisableAttachementsInPV" -Value 1 -Type DWord
          Set-ItemProperty -Path $pvPath -Name "DisableUnsafeLocationsInPV" -Value 1 -Type DWord

          # Add workspace as a trusted location so macros can run from it
          $tlPath = "HKCU:\Software\Microsoft\Office\16.0\Excel\Security\Trusted Locations\Location99"
          if (-not (Test-Path $tlPath)) { New-Item -Path $tlPath -Force | Out-Null }
          Set-ItemProperty -Path $tlPath -Name "Path" -Value "${{ github.workspace }}\" -Type String
          Set-ItemProperty -Path $tlPath -Name "AllowSubFolders" -Value 1 -Type DWord

          # Also trust the temp directory (staging files go there)
          $tlPath2 = "HKCU:\Software\Microsoft\Office\16.0\Excel\Security\Trusted Locations\Location98"
          if (-not (Test-Path $tlPath2)) { New-Item -Path $tlPath2 -Force | Out-Null }
          Set-ItemProperty -Path $tlPath2 -Name "Path" -Value "$env:LOCALAPPDATA\vbapm\" -Type String
          Set-ItemProperty -Path $tlPath2 -Name "AllowSubFolders" -Value 1 -Type DWord

          # Trust the system temp directory too
          $tlPath3 = "HKCU:\Software\Microsoft\Office\16.0\Excel\Security\Trusted Locations\Location97"
          if (-not (Test-Path $tlPath3)) { New-Item -Path $tlPath3 -Force | Out-Null }
          Set-ItemProperty -Path $tlPath3 -Name "Path" -Value "$env:TEMP\" -Type String
          Set-ItemProperty -Path $tlPath3 -Name "AllowSubFolders" -Value 1 -Type DWord

          Write-Host "Excel trust settings configured"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies and build
        run: |
          npm install
          npm run build

      - name: Install globally from local build
        shell: pwsh
        run: |
          npm install -g .

      - name: Verify installation
        shell: pwsh
        run: |
          vba --version

      # ── Diagnose Excel COM automation ──
      - name: Diagnose Excel COM
        shell: pwsh
        continue-on-error: true
        run: |
          Write-Host "=== Testing Excel COM automation ==="

          # Test 1: Direct PS7 COM test
          $excel = New-Object -ComObject "Excel.Application"
          $excel.Visible = $false
          $excel.DisplayAlerts = $false
          Write-Host "PASS: Excel COM (Version: $($excel.Version))"

          $bootstrapPath = "${{ github.workspace }}\scripts\bootstrap\build\bootstrap.xlsm"
          $wb = $excel.Workbooks.Open($bootstrapPath)
          Write-Host "PASS: bootstrap.xlsm opened"

          $vbp = $wb.VBProject
          Write-Host "PASS: VBProject accessible ($($vbp.VBComponents.Count) components)"

          $result = $excel.Run("Build.ImportGraph", "test")
          Write-Host "PASS (PS7 direct): $result"

          $wb.Close($false)
          $excel.Quit()
          [System.Runtime.InteropServices.Marshal]::ReleaseComObject($excel) | Out-Null
          Start-Sleep -Seconds 2

          # Test 2: Call run.ps1 via powershell.exe (PS5) — same as Node.js does
          $script = "${{ github.workspace }}\run-scripts\run.ps1"
          Write-Host "--- Testing via PS5 (powershell.exe -File run.ps1) ---"
          $testArgs = @(
            "-NoProfile",
            "-ExecutionPolicy", "Bypass",
            "-File", $script,
            "excel",
            "$bootstrapPath",
            "Build.ImportGraph",
            "{^qfile^q:^qtest.xlsm^q,^qname^q:^qVBAProject^q,^qsrc^q:[],^qreferences^q:[]}"
          )
          Write-Host "Command: powershell.exe $($testArgs -join ' ')"
          try {
            $ps5result = & powershell.exe @testArgs 2>&1
            Write-Host "PS5 result: $ps5result"
          } catch {
            Write-Host "PS5 error: $($_.Exception.Message)"
          }

          # Test 3: Call run.ps1 via cmd.exe — exactly as child_process.exec does
          Write-Host "--- Testing via cmd.exe (same as Node child_process.exec) ---"
          $cmdString = 'powershell -NoProfile -ExecutionPolicy Bypass -File "' + $script + '" "excel" "' + $bootstrapPath + '" "Build.ImportGraph" "{^qfile^q:^qtest.xlsm^q,^qname^q:^qVBAProject^q,^qsrc^q:[],^qreferences^q:[]}"'
          Write-Host "CMD command: $cmdString"
          try {
            $cmdResult = & cmd.exe /c $cmdString 2>&1
            Write-Host "CMD result: $cmdResult"
          } catch {
            Write-Host "CMD error: $($_.Exception.Message)"
          }

          Write-Host "=== Diagnostics complete ==="

      # ── Build the vbapm addin (needed for import/export COM calls) ──
      - name: Build vbapm addin
        id: build-addin
        shell: pwsh
        continue-on-error: true
        run: |
          npm run build:addins

      - name: Check addin build result
        shell: pwsh
        run: |
          if (Test-Path "addins/build/vbapm.xlam") {
            Write-Host "Addin built successfully"
            echo "ADDIN_AVAILABLE=true" >> $env:GITHUB_ENV
          } else {
            Write-Host "::warning::Addin build failed - project build, export and roundtrip tests will be skipped"
            echo "ADDIN_AVAILABLE=false" >> $env:GITHUB_ENV
          }

      # ── New project: new → build (needs addin since project has starter module) ──
      - name: Create a new xlsm project
        if: env.ADDIN_AVAILABLE == 'true'
        shell: pwsh
        run: |
          vba new my-project.xlsm

      - name: Show project structure
        if: env.ADDIN_AVAILABLE == 'true'
        shell: pwsh
        run: |
          Get-ChildItem -Recurse my-project | Select-Object FullName

      - name: Build the project
        if: env.ADDIN_AVAILABLE == 'true'
        shell: pwsh
        run: |
          cd my-project
          vba build

      - name: Verify build output exists
        if: env.ADDIN_AVAILABLE == 'true'
        shell: pwsh
        run: |
          if (Test-Path "my-project/build/my-project.xlsm") {
            Write-Host "Build succeeded: my-project.xlsm exists"
          } else {
            Write-Error "Build failed: my-project.xlsm not found"
            Get-ChildItem -Recurse my-project/build -ErrorAction SilentlyContinue | Select-Object FullName
            exit 1
          }

      # ── Export project (needs addin) ──
      - name: Export the project
        if: env.ADDIN_AVAILABLE == 'true'
        shell: pwsh
        run: |
          cd my-project
          vba export

      # ── Roundtrip test: new → add source → build → export → verify ──
      - name: Create roundtrip project
        if: env.ADDIN_AVAILABLE == 'true'
        shell: pwsh
        run: |
          vba new roundtrip-test.xlsm

      - name: Add a VBA module to the project
        if: env.ADDIN_AVAILABLE == 'true'
        shell: pwsh
        run: |
          $basContent = @"
          Attribute VB_Name = "MyModule"
          Public Function Add(a As Long, b As Long) As Long
              Add = a + b
          End Function
          "@
          # Trim leading spaces from here-string indentation
          $basContent = ($basContent -split "`n" | ForEach-Object { $_.TrimStart() }) -join "`r`n"
          [System.IO.File]::WriteAllText("roundtrip-test/src/MyModule.bas", $basContent)

          # Add the source to vba_package.toml
          Add-Content -Path "roundtrip-test/vba_package.toml" -Value "`n[src]`nMyModule = `"src/MyModule.bas`""

          Write-Host "=== vba_package.toml ==="
          Get-Content "roundtrip-test/vba_package.toml"
          Write-Host "`n=== src/MyModule.bas ==="
          Get-Content "roundtrip-test/src/MyModule.bas"

      - name: Build roundtrip project (imports VBA via COM)
        if: env.ADDIN_AVAILABLE == 'true'
        shell: pwsh
        run: |
          cd roundtrip-test
          vba build

      - name: Export roundtrip project (extracts VBA via COM)
        if: env.ADDIN_AVAILABLE == 'true'
        shell: pwsh
        run: |
          cd roundtrip-test
          vba export

      - name: Verify roundtrip - source file preserved
        if: env.ADDIN_AVAILABLE == 'true'
        shell: pwsh
        run: |
          $srcFile = "roundtrip-test/src/MyModule.bas"
          if (-not (Test-Path $srcFile)) {
            Write-Error "Roundtrip FAILED: $srcFile not found after export"
            Get-ChildItem -Recurse roundtrip-test/src -ErrorAction SilentlyContinue
            exit 1
          }

          $content = Get-Content $srcFile -Raw
          if ($content -match "Add = a \+ b") {
            Write-Host "Roundtrip PASSED: MyModule.bas contains expected function body"
          } else {
            Write-Error "Roundtrip FAILED: MyModule.bas does not contain expected content"
            Write-Host "=== Actual content ==="
            Get-Content $srcFile
            exit 1
          }

          # Verify the module is still referenced in the manifest
          $toml = Get-Content "roundtrip-test/vba_package.toml" -Raw
          if ($toml -match 'MyModule') {
            Write-Host "Roundtrip PASSED: vba_package.toml still references MyModule"
          } else {
            Write-Error "Roundtrip FAILED: vba_package.toml lost the MyModule reference"
            Write-Host "=== vba_package.toml ==="
            Get-Content "roundtrip-test/vba_package.toml"
            exit 1
          }

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: vba-excel-project
          path: |
            my-project/
            roundtrip-test/
