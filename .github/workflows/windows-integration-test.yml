name: Windows Integration Test

on:
  push:
    branches:
      - main*
      - dev
      - dev-*
    paths-ignore:
      - '**/*.md'
  pull_request:
  workflow_dispatch:

jobs:
  excel-integration:
    strategy:
      matrix:
        os: [windows-2022, windows-2025]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup VBA runtime
        uses: DecimalTurn/setup-vba@main
        with:
          office-apps: Excel

      - name: Setup Node.js
        uses: actions/setup-node@v1
        with:
          node-version: 12.x

      - name: Install CLI standalone App
        shell: pwsh
        run: |
          # Determine the latest release tag via the GitHub API
          $release = Invoke-RestMethod "https://api.github.com/repos/vba-blocks/vba-blocks/releases/latest"
          $version = $release.tag_name   # e.g. "v0.5.3"
          Write-Output "Installing vba-blocks $version"

          # Download the install script and save to a temp file so we can
          # pass the version as a proper argument (iex doesn't support args).
          $response = iwr "https://vba-blocks.com/install.ps1" -AllowInsecureRedirect
          $scriptPath = "$env:TEMP\install-vba-blocks.ps1"
          [System.IO.File]::WriteAllBytes($scriptPath, $response.Content)
          & $scriptPath $version

          # Persist CLI path for subsequent workflow steps.
          $binDir = Join-Path $env:APPDATA "vba-blocks\bin"
          if (!(Test-Path (Join-Path $binDir "vba.cmd"))) {
            throw "Expected vba.cmd in $binDir, but it was not found."
          }
          $binDir | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Install Node dependencies and build
        run: |
          npm install
          npm run build

      # - name: Install globally from local build
      #   shell: pwsh
      #   run: |
      #     npm install -g .

      - name: Verify installation
        shell: pwsh
        run: |
          where.exe vba
          vba --version

      - name: Build Addins
        shell: pwsh
        run: |
          npm run build:addins

      - name: Run e2e tests
        shell: pwsh
        run: |
          npm run test:e2e
