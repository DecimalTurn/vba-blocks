name: Windows Integration Test

on:
  push:
    branches:
      - main*
      - dev
      - dev-*
    paths-ignore:
      - '**/*.md'
      - '.github/workflows/prepare-release.yml'
      - '.github/workflows/publish.yml'
  pull_request:
  workflow_dispatch:

jobs:
  excel-integration:
    strategy:
      matrix:
        os: [windows-2022, windows-2025]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Setup VBA runtime
        uses: DecimalTurn/setup-vba@main
        with:
          office-apps: Excel

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22.x

      - name: Install Node dependencies and build
        run: |
          npm install --ci
          npm run build:cli
          npm run build:addins

      - name: Install CLI standalone App (local build)
        shell: pwsh
        run: |
          .\installer\devinstall.ps1

      - name: Verify installation
        shell: pwsh
        run: |
          where.exe vba
          vba --version

      - name: Run e2e tests (installed CLI)
        shell: pwsh
        run: |
          $env:VBA_BIN_DIR = Join-Path $env:APPDATA "vbapm\bin"
          Write-Output "Using VBA_BIN_DIR=$env:VBA_BIN_DIR"
          npm run test:e2e
