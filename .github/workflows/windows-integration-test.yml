name: Windows Integration Test

on:
  push:
    branches:
      - main*
      - dev
      - dev-*
    paths-ignore:
      - '**/*.md'
  pull_request:
  workflow_dispatch:

jobs:
  excel-integration:
    strategy:
      matrix:
        os: [windows-2022, windows-2025]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup VBA runtime
        uses: DecimalTurn/setup-vba@main
        with:
          office-apps: Excel

      - name: Setup Node.js
        uses: actions/setup-node@v1
        with:
          node-version: 12.x

      - name: Install Node dependencies and build
        run: |
          npm install
          npm run build
          npm run build:addins

      - name: Install CLI standalone App (local build)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $libDir = Join-Path $env:APPDATA "vba-blocks"
          $binDir = Join-Path $libDir "bin"
          $addinsDir = Join-Path $libDir "addins\build"

          Write-Output "Installing vba-blocks from local build artifacts"

          New-Item -ItemType Directory -Force -Path $libDir | Out-Null

          # Mirror packaged layout into %APPDATA%\vba-blocks (no zip extraction needed).
          $sources = @("bin", "lib", "vendor", "run-scripts", "addins")
          foreach ($source in $sources) {
            $sourcePath = Join-Path $PWD $source
            $destPath = Join-Path $libDir $source

            if (!(Test-Path $sourcePath)) {
              throw "Expected local build path not found: $sourcePath"
            }

            if (Test-Path $destPath) {
              Remove-Item $destPath -Recurse -Force
            }

            Copy-Item $sourcePath $destPath -Recurse -Force
          }

          Write-Output "[3/5] Adding vba-blocks to PATH..."
          $user = [EnvironmentVariableTarget]::User
          $path = [Environment]::GetEnvironmentVariable('Path', $user)
          if (!((";$path;").ToLower() -like "*;$binDir;*".ToLower())) {
            [Environment]::SetEnvironmentVariable('Path', "$path;$binDir", $user)
          }
          $env:Path += ";$binDir"
          $binDir | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

          function New-Shortcut ($src, $dest) {
            try {
              $wshShell = New-Object -comObject WScript.Shell
              $shortcut = $wshShell.CreateShortcut($dest)
              $shortcut.TargetPath = $src
              $shortcut.Save()
            } catch {
              Write-Output "Failed to link add-ins, they can instead be found in $addinsDir."
            }
          }

          Write-Output "[4/5] Creating shortcut to add-ins..."
          New-Shortcut "$addinsDir" "$env:AppData\Microsoft\Addins\vba-blocks Add-ins.lnk"

          function Enable-VBOM ($app) {
            try {
              $curVer = Get-ItemProperty -Path Registry::HKEY_CLASSES_ROOT\$app.Application\CurVer -ErrorAction Stop
              $version = $curVer.'(default)'.replace("$app.Application.", "") + ".0"
              Set-ItemProperty -Path HKCU:\Software\Microsoft\Office\$version\$app\Security -Name AccessVBOM -Value 1 -ErrorAction Stop
            } catch {
              Write-Output "Failed to enable access to VBA project object model for $app."
            }
          }

          Write-Output "[5/5] Enabling access to VBA project object model..."
          Enable-VBOM "Excel"

          if (!(Test-Path (Join-Path $binDir "vba.cmd"))) {
            throw "Expected vba.cmd in $binDir, but it was not found."
          }

      # - name: Install globally from local build
      #   shell: pwsh
      #   run: |
      #     npm install -g .

      - name: Verify installation
        shell: pwsh
        run: |
          where.exe vba
          vba --version

      - name: Run e2e tests
        shell: pwsh
        run: |
          npm run test:e2e
