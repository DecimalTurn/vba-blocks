name: Windows Integration Test

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  # Quick smoke test without Office - runs on every push
  smoke-test:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies and build
        run: |
          npm install
          npm run build

      - name: Install globally from local build
        shell: pwsh
        run: |
          npm install -g .

      - name: Verify installation
        shell: pwsh
        run: |
          vba --version
          vba --help

      - name: Create a new VBA package
        shell: pwsh
        run: |
          vba new my-package --package

      - name: Show project structure
        shell: pwsh
        run: |
          Get-ChildItem -Recurse my-package | Select-Object FullName

      - name: Test vba init (package mode)
        shell: pwsh
        run: |
          mkdir init-test
          cd init-test
          vba init --package --name my-library --no-git

          if (-not (Test-Path "vba-block.toml")) {
            Write-Error "vba init FAILED: vba-block.toml not found"
            exit 1
          }

          $toml = Get-Content "vba-block.toml" -Raw
          if ($toml -match 'name = "my-library"') {
            Write-Host "vba init PASSED: project name set correctly"
          } else {
            Write-Error "vba init FAILED: unexpected toml content"
            Write-Host $toml
            exit 1
          }

          if (Test-Path "src") {
            Write-Host "vba init PASSED: src/ directory created"
          } else {
            Write-Error "vba init FAILED: src/ directory not found"
            exit 1
          }

      - name: Upload project artifact
        uses: actions/upload-artifact@v4
        with:
          name: vba-package
          path: my-package/

  # Full integration test with Office installed
  excel-integration:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup VBA runtime
        uses: DecimalTurn/setup-vba@main
        with:
          office-apps: Excel

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies and build
        run: |
          npm install
          npm run build

      - name: Install globally from local build
        shell: pwsh
        run: |
          npm install -g .

      - name: Verify installation
        shell: pwsh
        run: |
          vba --version

      # ── Empty project: new → build (no addin needed for empty projects) ──
      - name: Create a new xlsm project
        shell: pwsh
        run: |
          vba new my-project.xlsm

      - name: Show project structure
        shell: pwsh
        run: |
          Get-ChildItem -Recurse my-project | Select-Object FullName

      - name: Build the empty project
        shell: pwsh
        run: |
          cd my-project
          vba build

      - name: Verify build output exists
        shell: pwsh
        run: |
          if (Test-Path "my-project/build/my-project.xlsm") {
            Write-Host "Build succeeded: my-project.xlsm exists"
          } else {
            Write-Error "Build failed: my-project.xlsm not found"
            Get-ChildItem -Recurse my-project/build -ErrorAction SilentlyContinue | Select-Object FullName
            exit 1
          }

      # ── Build the vba-blocks addin (needed for import/export COM calls) ──
      - name: Build vba-blocks addin
        id: build-addin
        shell: pwsh
        continue-on-error: true
        run: |
          npm run build:addins

      - name: Check addin build result
        shell: pwsh
        run: |
          if (Test-Path "addins/build/vba-blocks.xlam") {
            Write-Host "Addin built successfully"
            echo "ADDIN_AVAILABLE=true" >> $env:GITHUB_ENV
          } else {
            Write-Host "::warning::Addin build failed - export and roundtrip tests will be skipped"
            echo "ADDIN_AVAILABLE=false" >> $env:GITHUB_ENV
          }

      # ── Export empty project (needs addin) ──
      - name: Export the empty project
        if: env.ADDIN_AVAILABLE == 'true'
        shell: pwsh
        run: |
          cd my-project
          vba export

      # ── Roundtrip test: new → add source → build → export → verify ──
      - name: Create roundtrip project
        if: env.ADDIN_AVAILABLE == 'true'
        shell: pwsh
        run: |
          vba new roundtrip-test.xlsm

      - name: Add a VBA module to the project
        if: env.ADDIN_AVAILABLE == 'true'
        shell: pwsh
        run: |
          $basContent = @"
          Attribute VB_Name = "MyModule"
          Public Function Add(a As Long, b As Long) As Long
              Add = a + b
          End Function
          "@
          # Trim leading spaces from here-string indentation
          $basContent = ($basContent -split "`n" | ForEach-Object { $_.TrimStart() }) -join "`r`n"
          [System.IO.File]::WriteAllText("roundtrip-test/src/MyModule.bas", $basContent)

          # Add the source to vba-block.toml
          Add-Content -Path "roundtrip-test/vba-block.toml" -Value "`n[src]`nMyModule = `"src/MyModule.bas`""

          Write-Host "=== vba-block.toml ==="
          Get-Content "roundtrip-test/vba-block.toml"
          Write-Host "`n=== src/MyModule.bas ==="
          Get-Content "roundtrip-test/src/MyModule.bas"

      - name: Build roundtrip project (imports VBA via COM)
        if: env.ADDIN_AVAILABLE == 'true'
        shell: pwsh
        run: |
          cd roundtrip-test
          vba build

      - name: Export roundtrip project (extracts VBA via COM)
        if: env.ADDIN_AVAILABLE == 'true'
        shell: pwsh
        run: |
          cd roundtrip-test
          vba export

      - name: Verify roundtrip - source file preserved
        if: env.ADDIN_AVAILABLE == 'true'
        shell: pwsh
        run: |
          $srcFile = "roundtrip-test/src/MyModule.bas"
          if (-not (Test-Path $srcFile)) {
            Write-Error "Roundtrip FAILED: $srcFile not found after export"
            Get-ChildItem -Recurse roundtrip-test/src -ErrorAction SilentlyContinue
            exit 1
          }

          $content = Get-Content $srcFile -Raw
          if ($content -match "Add = a \+ b") {
            Write-Host "Roundtrip PASSED: MyModule.bas contains expected function body"
          } else {
            Write-Error "Roundtrip FAILED: MyModule.bas does not contain expected content"
            Write-Host "=== Actual content ==="
            Get-Content $srcFile
            exit 1
          }

          # Verify the module is still referenced in the manifest
          $toml = Get-Content "roundtrip-test/vba-block.toml" -Raw
          if ($toml -match 'MyModule') {
            Write-Host "Roundtrip PASSED: vba-block.toml still references MyModule"
          } else {
            Write-Error "Roundtrip FAILED: vba-block.toml lost the MyModule reference"
            Write-Host "=== vba-block.toml ==="
            Get-Content "roundtrip-test/vba-block.toml"
            exit 1
          }

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: vba-excel-project
          path: |
            my-project/
            roundtrip-test/
