name: Prepare Release

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Which part of the version to bump (major, minor, patch)'
        required: true
        default: 'patch'
        type: choice
        options:
            - major
            - minor
            - patch
            - no-bump
      remove_suffix:
        description: 'Remove pre-release suffix (e.g. -alpha)'
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  prepare-release:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.next_version.outputs.tag }}
      sha: ${{ steps.commit.outputs.sha }}
      version: ${{ steps.next_version.outputs.version }}
      release_url: ${{ steps.create_draft_release.outputs.url }}
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.ref_name }}
          fetch-depth: 0
          fetch-tags: true

      - uses: actions/setup-node@v4
        with:
          node-version: 22.x

      - name: Get current version
        id: current_version
        run: |
          current=$(jq -r '.version' package.json)
          # Extract base version and suffix separately
          base="${current%%-*}"
          if [[ "$current" == *-* ]]; then
            suffix="${current#*-}"
          else
            suffix=""
          fi
          echo "Current version: $current (base=$base, suffix=$suffix)"
          echo "base=$base" >> $GITHUB_OUTPUT
          echo "suffix=$suffix" >> $GITHUB_OUTPUT

      - name: Calculate next version
        id: next_version
        run: |
            IFS='.' read -r major minor patch <<< "${{ steps.current_version.outputs.base }}"
            if [[ "${{ github.event.inputs.version_bump }}" == "no-bump" ]]; then
              new_version="${{ steps.current_version.outputs.base }}"
              suffix="${{ steps.current_version.outputs.suffix }}"
              if [[ -n "$suffix" && "${{ github.event.inputs.remove_suffix }}" != "true" ]]; then
                new_version="$new_version-$suffix"
              fi
              echo "No version bump selected."
            else
              case "${{ github.event.inputs.version_bump }}" in
                major)
                  ((major+=1)); minor=0; patch=0;;
                minor)
                  ((minor+=1)); patch=0;;
                patch)
                  ((patch+=1));;
              esac
              new_version="$major.$minor.$patch"
              suffix="${{ steps.current_version.outputs.suffix }}"
              if [[ -n "$suffix" && "${{ github.event.inputs.remove_suffix }}" != "true" ]]; then
                new_version="$new_version-$suffix"
              fi
              echo "Next version: $new_version"
            fi
            echo "version=$new_version" >> $GITHUB_OUTPUT
            echo "tag=v$new_version" >> $GITHUB_OUTPUT

      - name: Update package.json
        run: |
            if [[ "${{ github.event.inputs.version_bump }}" != "no-bump" ]]; then
              NEW_VERSION="${{ steps.next_version.outputs.version }}"
              jq --arg v "$NEW_VERSION" '.version = $v' package.json > package.json.tmp
              mv package.json.tmp package.json
            else
              echo "Skipping package.json update (no-bump selected)"
            fi

      - name: Update package-lock.json
        if: github.event.inputs.version_bump != 'no-bump'
        run: npm install --package-lock-only

      - name: Commit changes
        id: commit
        run: |
            if [[ "${{ github.event.inputs.version_bump }}" != "no-bump" ]]; then
              git config user.name "github-actions"
              git config user.email "github-actions@github.com"
              git add package.json package-lock.json
              git commit -m "chore: bump version to ${{ steps.next_version.outputs.version }}"
              git push origin ${{ github.ref_name }}
              echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
            else
              echo "Skipping commit (no-bump selected)"
              echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
            fi

      - name: Create Draft Release
        id: create_draft_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.next_version.outputs.tag }}
          target_commitish: ${{ steps.commit.outputs.sha }}
          generate_release_notes: true
          draft: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-packages:
    needs: prepare-release
    runs-on: windows-2022
    outputs:
      release_url: ${{ steps.upload_assets.outputs.url }}
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare-release.outputs.sha }}

      - uses: DecimalTurn/setup-vba@main
        with:
          office-apps: Excel

      - uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Build CLI
        run: npm run build:cli

      - name: Build addins
        run: npm run build:addins

      - name: Create packages
        run: node scripts/create-packages

      - name: Upload release assets
        id: upload_assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare-release.outputs.tag }}
          files: |
            dist/vbapm-win.zip
            dist/vbapm-mac.tar.gz
          draft: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Add package summary
        shell: pwsh
        run: |
          $winSize = (Get-Item dist/vbapm-win.zip).Length / 1MB
          $macSize = (Get-Item dist/vbapm-mac.tar.gz).Length / 1MB
          @"
          ## Packages uploaded

          | File | Size |
          |------|------|
          | ``vbapm-win.zip`` | $([math]::Round($winSize, 2)) MB |
          | ``vbapm-mac.tar.gz`` | $([math]::Round($macSize, 2)) MB |
          "@ >> $env:GITHUB_STEP_SUMMARY

  report:
    needs: [prepare-release, build-packages]
    runs-on: ubuntu-latest
    steps:
      - name: Add release link to summary
        run: |
          release_url="${{ needs.build-packages.outputs.release_url }}"
          # Fall back to the URL captured before asset upload if needed
          if [[ -z "$release_url" ]]; then
            release_url="${{ needs.prepare-release.outputs.release_url }}"
          fi
          {
            echo "## Release prepared"
            echo ""
            echo "- Tag: \`${{ needs.prepare-release.outputs.tag }}\`"
            echo "- Draft release: [$release_url]($release_url)"
          } >> "$GITHUB_STEP_SUMMARY"
